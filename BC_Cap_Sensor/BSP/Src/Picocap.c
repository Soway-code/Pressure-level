/**@file        Picocap.c
* @brief        PCap芯片驱动程序
* @details      PCap 电容数据和温度数据采集
* @author       杨春林
* @date         2020-04-29
* @version      V1.0.1
* @copyright    2020-2030,深圳市信为科技发展有限公司
**********************************************************************************
* @par 修改日志:
* <table>
* <tr><th>Date        <th>Version  <th>Author    <th>Description
* <tr><td>2020/04/29  <td>1.0.1    <td>杨春林    <td>修改了写入固件和配置信息函数的
* 程序代码, 删除了延时等待函数
* </table>
*
**********************************************************************************
*/

#include "Picocap.h"
#include "spi_bsp.h"


///< PCap固件
const unsigned char SRAM_DATA[] = {
0x00,0x00,0x00,0x62,0x63,0x00,0x65,0xBE,0x01,0x20,0x26,0x42,0x5C,0x48,0xA0,0x03,
0x21,0xE4,0x20,0x31,0xA1,0x03,0x21,0xE4,0x20,0x31,0x84,0x01,0x23,0x63,0x01,0x00,
0x00,0x00,0x00,0x00,0x20,0x0B,0x43,0x58,0xC0,0xFE,0x43,0xC0,0x44,0x7A,0x7E,0x20,
0x0B,0xC0,0xC0,0xC0,0xC8,0xFF,0x43,0xED,0x44,0xC0,0xC0,0xC0,0xF6,0xFF,0x43,0xEC,
0x44,0xC0,0xC0,0xC0,0xC8,0xFF,0x41,0x23,0x94,0xD0,0x43,0xEE,0x44,0xD2,0x43,0xEF,
0x44,0x20,0x5A,0x70,0x60,0x71,0x61,0x78,0x68,0x02,0x7A,0xF3,0x43,0xC7,0xFE,0x41,
0xEB,0x45,0x5A,0x21,0xDF,0x46,0x46,0x46,0x46,0xEC,0x44,0xC0,0xC0,0xC0,0xC8,0xFF,
0x43,0x55,0xED,0x45,0xEC,0x51,0xF4,0x41,0x23,0x88,0xEA,0x45,0xF5,0x41,0x23,0x88,
0xE9,0x45,0x1D,0x41,0x43,0x58,0xEA,0x21,0x99,0xE9,0x50,0x46,0xEB,0x44,0xA9,0x02,
0xEB,0x59,0x43,0xCA,0xFE,0x41,0x5C,0xA8,0x03,0xC0,0x5A,0xEB,0x45,0xEB,0x41,0xF2,
0x45,0xF6,0x41,0x23,0x88,0xEA,0x45,0xF7,0x41,0x23,0x88,0xE9,0x45,0x1F,0x41,0x43,
0x58,0xEA,0x21,0x99,0xE9,0x50,0x46,0xEB,0x44,0xA9,0x02,0xEB,0x59,0x43,0xCA,0xFE,
0x41,0x5C,0xA8,0x03,0xC0,0x5A,0xEB,0x45,0xEB,0x41,0xF3,0x45,0x02,0xFF,0xFF,0xFF,
0x47,0x47,0x47,0x47,0x47,0x47,0x47,0x47,0x7C,0x7D,0x45,0x41,0x02,0x47,0x47,0x47,
0x47,0x47,0x47,0x47,0xF0,0x7C,0x6D,0x45,0x41,0x6C,0x7D,0x45,0x41,0x02,0x47,0x47,
0x47,0x47,0x47,0x47,0x47,0xF0,0x6C,0x7D,0x45,0x41,0x02,0x47,0x47,0x47,0x47,0x47,
0x47,0x47,0xF0,0x7C,0x6D,0x45,0x41,0x45,0x41,0x02,0x47,0x47,0x47,0x47,0x47,0x47,
0x47,0xF0,0x7C,0x6D,0x45,0x41,0x02,0x47,0x47,0x47,0x47,0x47,0x47,0x47,0x02,0x4F,
0x4F,0x4F,0x4F,0x4F,0x4F,0x4F,0x4F,0x4F,0x4F,0x4F,0x4F,0x4F,0x4F,0x4F,0x4F,0x4F,
0x4F,0x4F,0x4F,0x4F,0x4F,0x4F,0x4F,0x4F,0x4F,0x4F,0x4F,0x4F,0x4F,0x4F,0x4F,0x4F,
0x4F,0x4F,0x4F,0x4F,0x4F,0x4F,0x4F,0x4F,0x4F,0x4F,0x4F,0x4F,0x4F,0x4F,0x4F,0x02,
0x4E,0x4E,0x4E,0x4E,0x4E,0x4E,0x4E,0x4E,0x4E,0x4E,0x4E,0x4E,0x4E,0x4E,0x4E,0x4E,
0x4E,0x4E,0x4E,0x4E,0x4E,0x4E,0x4E,0x4E,0x4E,0x4E,0x4E,0x4E,0x4E,0x4E,0x4E,0x4E,
0x4E,0x4E,0x4E,0x4E,0x4E,0x4E,0x4E,0x4E,0x4E,0x4E,0x4E,0x4E,0x4E,0x4E,0x4E,0x4E,
0x02,0x56,0x56,0x56,0x56,0x56,0x56,0x56,0x56,0x56,0x56,0x56,0x56,0x56,0x56,0x56,
0x56,0x56,0x56,0x56,0x56,0x56,0x56,0x56,0x56,0x56,0x56,0x56,0x56,0x56,0x56,0x56,
0x56,0x56,0x56,0x56,0x56,0x56,0x56,0x56,0x56,0x56,0x56,0x56,0x56,0x56,0x56,0x56,
0x56,0x02,0x5E,0x5E,0x5E,0x5E,0x5E,0x5E,0x5E,0x5E,0x5E,0x5E,0x5E,0x5E,0x5E,0x5E,
0x5E,0x5E,0x5E,0x5E,0x5E,0x5E,0x5E,0x5E,0x5E,0x5E,0x5E,0x5E,0x5E,0x5E,0x5E,0x5E,
0x5E,0x5E,0x5E,0x5E,0x5E,0x5E,0x5E,0x5E,0x5E,0x5E,0x5E,0x5E,0x5E,0x5E,0x5E,0x5E,
0x5E,0x5E,0x5E,0x02,0x6A,0xFD,0x43,0x40,0x4F,0x4F,0x4F,0xEB,0x45,0x7A,0xF9,0x41,
0x43,0x58,0xEB,0x21,0x99,0xEA,0x44,0xC0,0xC0,0xC0,0xF1,0xFF,0x43,0xEC,0x44,0xC0,
0xC0,0xC0,0xC8,0xFF,0x41,0xED,0x45,0xC0,0x41,0xC0,0xC0,0xC0,0xF8,0xFF,0x43,0xE9,
0x44,0x6A,0x1D,0x43,0xAB,0x01,0xEA,0x58,0x8E,0x03,0xEC,0x53,0x1D,0x50,0x1F,0x44,
0xEC,0x53,0xED,0x53,0xE9,0x43,0xEC,0x58,0xAC,0xE6,0x8E,0x26,0xC0,0xC0,0xC0,0xF9,
0xFF,0x43,0xEC,0x44,0xC0,0xC0,0xC0,0xC8,0xFF,0x43,0xED,0x44,0xC0,0x41,0xC0,0xC0,
0xC0,0xFC,0xFF,0x43,0xE9,0x44,0x1D,0x43,0x1F,0x59,0xE9,0x43,0xED,0x53,0xEC,0x53,
0x58,0xAC,0xF2,0x7A,0xC0,0xC0,0xC0,0xC9,0xFF,0x43,0xEC,0x44,0xE7,0x44,0xE8,0x44,
0xC0,0xC0,0xC0,0xC8,0xFF,0x43,0xED,0x44,0x1F,0x43,0x4E,0x4E,0x4E,0x44,0xC0,0xC0,
0xC0,0xCF,0xFF,0x43,0xE9,0x44,0x8E,0x07,0xC0,0xC0,0xC0,0xCB,0xFF,0x43,0xE9,0x44,
0x40,0x5D,0x1D,0x43,0x1F,0x21,0xCA,0xE8,0x43,0xEC,0x44,0x1D,0x45,0xF8,0x43,0xAB,
0x0C,0xC0,0x41,0xED,0x53,0x53,0x1F,0x43,0x4E,0x4E,0x4E,0x44,0xE7,0x53,0xC0,0x41,
0xE8,0x53,0xE7,0x53,0x41,0xEC,0x45,0xE9,0x43,0x5C,0xAC,0xD3,0xC0,0xC0,0xC0,0xCF,
0xFF,0x43,0xE9,0x44,0xE8,0x41,0xE9,0x43,0x5C,0xA8,0x0C,0xC0,0x41,0xE8,0x43,0x53,
0xEC,0x44,0x1D,0x44,0x59,0x43,0xAB,0xEB,0xC8,0x43,0x46,0x46,0x46,0x44,0x7A,0x8A,
0x1B,0xC0,0x43,0x40,0x5D,0x5D,0x90,0x15,0xC8,0x45,0xC9,0x45,0xF8,0x43,0xAA,0x0B,
0xCA,0x45,0xCB,0x45,0xCC,0x45,0xCD,0x45,0xCE,0x45,0xCF,0x45,0x00,0x02,0xC0,0x43,
0x4E,0x4E,0xEA,0x44,0xE9,0x44,0x8E,0x06,0xC0,0x43,0x4E,0xEA,0x44,0xE9,0x44,0xF8,
0x43,0xAB,0x13,0xC0,0x43,0x4E,0xEA,0x44,0x4E,0x50,0xE9,0x44,0x8E,0x08,0xC0,0x43,
0xEA,0x44,0x4E,0x4E,0x50,0xE9,0x44,0xC0,0xC0,0xC0,0xC8,0xFF,0x43,0x4E,0x4E,0xE9,
0x51,0x91,0x01,0x23,0x5A,0xEA,0x43,0xE9,0x51,0x92,0x01,0x23,0x5A,0xEA,0x43,0xE9,
0x51,0x93,0x01,0x23,0x5A,0xEA,0x43,0xE9,0x51,0x94,0x01,0x23,0x5A,0xEA,0x43,0xE9,
0x51,0x95,0x01,0x23,0x5A,0xEA,0x43,0xE9,0x51,0x96,0x01,0x23,0x5A,0xEA,0x43,0xE9,
0x51,0x97,0x01,0x23,0x5A,0xEA,0x43,0xE9,0x51,0x02,0xE9,0x43,0x46,0x46,0xEC,0x44,
0x1D,0x45,0x02,0x7A,0xFA,0x41,0x4F,0x4F,0x4F,0xE7,0x45,0x5A,0xFB,0x43,0xE7,0x75,
0x21,0xCA,0x65,0xD0,0x45,0x5A,0xFC,0x43,0xE7,0x21,0xCA,0xD1,0x45,0x5A,0xFD,0x43,
0xE7,0x21,0xCA,0xD2,0x45,0x79,0x69,0x02,0xD7,0xFE,0x43,0xE7,0x45,0x5D,0xAD,0x01,
0x5D,0x45,0x41,0x02,0x1F,0x43,0x1D,0x44,0xC0,0x43,0xEC,0x51,0xED,0x51,0x5D,0xAA,
0xF2,0x02,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
};

///< 配置寄存器
///< 详见Picocap.h的21个配置寄存器的配置
const unsigned long REG[] = {
    REG0_OTP_CONFIG_VALUE,              //addr0
    REG1_IN_OSC_CONFIG_VALUE,           //addr1
    REG2_CAP_MEASURE_VALUE,             //addr2
    REG3_CAP_MEASURE_VALUE,             //addr3
    REG4_CAP_TEMP_MEASURE_VALUE,        //addr4
    REG5_TEMP_MEASURE_VALUE,            //addr5
    REG6_TEMP_MEASURE_VALUE,            //addr6            
    REG7_CONFIG_VALUE,                  //addr7
    REG8_DSP_CONFIG_VALUE,              //addr8
    REG9_GPIO_CONFIG_VALUE,             //addr9
    REG10_IN_1_8V_REGULATOR_VALUE,      //addr10
    PARAM0_VALUE,                       //addr11
    PARAM1_VALUE,                       //addr12
    PARAM2_PULSE_SELECT_VALUE,          //addr13
    PARAM3_PULSE0_SLOPE_VALUE,          //addr14
    PARAM4_PULSE0_OFFSET_VALUE,         //addr15
    PARAM5_PULSE1_SLOPE_VALUE,          //addr16
    PARAM6_PULSE1_OFFSET_VALUE,         //addr17
    PARAM7_CAP_MEASURE_CONFIG_VALUE,    //addr18
    PARAM8_GAIN_CORR_VALUE,             //addr19
    REG20_RUNBIT_VALUE,                 //addr20
};

/**@brief       PCap芯片片选引脚配置
* @return       函数执行结果
* - None
*/
static void PCap_NSS_Config(void)
{
    GPIO_InitTypeDef GPIO_InitStruct = {0};

    PCAP_SPI_NSS_GPIO_CLK();

    /*Configure GPIO pin Output Level */
    HAL_GPIO_WritePin(PCAP_SPI_NSS_GPIO_PORT, PCAP_SPI_NSS_GPIO_PIN, GPIO_PIN_SET);

    GPIO_InitStruct.Pin = PCAP_SPI_NSS_GPIO_PIN;
    GPIO_InitStruct.Mode = GPIO_MODE_OUTPUT_PP;
    GPIO_InitStruct.Pull = GPIO_PULLUP;
    GPIO_InitStruct.Speed = GPIO_SPEED_FREQ_LOW;
    HAL_GPIO_Init(PCAP_SPI_NSS_GPIO_PORT, &GPIO_InitStruct);
}

/**@brief       PCap芯片初始化
* @return       函数执行结果
* - None
*/
void PCap_Init(void)
{
    //写PCap SRAM错误
    uint8_t WrSramErr;
    //写PCap 次数
    uint8_t WrSramCnt;

    WrSramErr = 0;
    WrSramCnt = 0;

    //片选引脚配置
    PCap_NSS_Config();
    //SPI初始化
    BSP_SPI_Init();
    //PCap复位
    PCap_Reset();
    //延时1ms
    HAL_Delay(1);
    //写PCap固件
    do
    {
        WrSramErr = PCap_WR_SRAM();
        if(OP_SUCCESS == WrSramErr)
        {
            break;
        }

        PCap_Reset();
        WrSramCnt++;
        HAL_Delay(1);
    }while(WRITE_PCAPFIRM_ERR_MAX > WrSramCnt);

    HAL_Delay(1);
    //PCap寄存器配置
    PCap_Reg_Config();
    //PCap使能
    PCap_Enable();
    HAL_Delay(1);
    //PCap部分复位
    PCap_PTL_Reset();
    HAL_Delay(1);
    //PCap测量开始
    PCap_Measure();
}

/**@brief       PCap芯片复位
* @return       函数执行结果
* - None
*/
void PCap_Reset(void)
{
    uint8_t cmd;
    
    PCAP_SPI_ENABLE;
    cmd = PCAP_RESET_CMD;
    BSP_SPI_Transmit(&cmd, 1);
    PCAP_SPI_DISABLE;
}

/**@brief       PCap芯片部分复位
* @return       函数执行结果
* - None
*/
void PCap_PTL_Reset(void)
{
    uint8_t cmd;
    
    PCAP_SPI_ENABLE;
    cmd = PCAP_PTL_RESET_CMD;
    BSP_SPI_Transmit(&cmd, 1);
    PCAP_SPI_DISABLE;
}

/**@brief       PCap芯片开始测量
* @return       函数执行结果
* - None
*/
void PCap_Measure(void)
{
    uint8_t cmd;
    
    PCAP_SPI_ENABLE;
    cmd = PCAP_MEASURE_CMD;
    BSP_SPI_Transmit(&cmd, 1);
    PCAP_SPI_DISABLE;
}

/**@brief       PCap芯片启动
* @return       函数执行结果
* - None
*/
void PCap_Enable(void)
{
    uint8_t cmd[4];
    
    PCAP_SPI_ENABLE;
    cmd[0] = PCAP_WRITE_CONFIG_OPT | CONFIG_REG20_ADDR;
    cmd[1] = 0;
    cmd[2] = 0;
    cmd[3] = REG20_RUN_ENABLE;
    BSP_SPI_Transmit(cmd, 4);
    PCAP_SPI_DISABLE;
}

/**@brief       PCap芯片停止运行
* @return       函数执行结果
* - None
*/
void PCap_Disable(void)
{
    uint8_t cmd[4];

    PCAP_SPI_ENABLE;
    cmd[0] = PCAP_WRITE_CONFIG_OPT | CONFIG_REG20_ADDR;
    cmd[1] = 0;
    cmd[2] = 0;
    cmd[3] = REG20_RUN_DISABLE;
    BSP_SPI_Transmit(cmd, 4);
    PCAP_SPI_DISABLE;
}

/**@brief       向PCap芯片写入固件
* @param[in]    Msg:消息首地址;
* @param[in]    MsgLen:消息帧长度;
* @return       函数执行结果
* - OP_SUCCESS(写入成功)
* - OP_FAILED(写入失败)
*/
uint8_t PCap_WR_SRAM(void)
{
    uint8_t errcnt;
    uint8_t *pWrdata;
    uint16_t pCnt;
    uint8_t cmd[3];
    uint8_t receive[3];

    errcnt = 0;
    pWrdata = (uint8_t *)SRAM_DATA;

    for(pCnt = 0; pCnt < SRAM_DATA_NUM; pCnt++)
    {
        do
        {
            cmd[0] = ((PCAP_WRITE_SRAM_OPT << 8) | pCnt) >> 8;
            cmd[1] = ((PCAP_WRITE_SRAM_OPT << 8) | pCnt) & 0xFF;
            cmd[2] = *pWrdata;
            PCAP_SPI_ENABLE;            
            BSP_SPI_Transmit(cmd, 3);
            PCAP_SPI_DISABLE;
           
            cmd[0] = ((PCAP_READ_SRAM_OPT << 8) | pCnt) >> 8;
            cmd[1] = ((PCAP_READ_SRAM_OPT << 8) | pCnt) & 0xFF;
            cmd[2] = 0;
            PCAP_SPI_ENABLE;            
            BSP_SPI_TransmitReceive(cmd, receive, 3);
            PCAP_SPI_DISABLE;

            errcnt++;

            if(WRITE_PCAPFIRM_ERR_MAX < errcnt)
            {
                return OP_FAILED;
            }

        }while(*pWrdata != receive[2]);

        errcnt = 0;
        pWrdata++;
    }

    return OP_SUCCESS;
}

/**@brief       向PCap芯片写入配置信息
* @return       函数执行结果
* - None
*/
void PCap_Reg_Config(void)
{
    uint8_t rCnt;
    uint8_t cmd[4];

    for(rCnt = 0; rCnt < REG_CONF_NUM; rCnt++)
    {
        cmd[0] = PCAP_WRITE_CONFIG_OPT | rCnt;
        cmd[1] = REG[rCnt] >> 16;
        cmd[2] = REG[rCnt] >> 8;
        cmd[3] = REG[rCnt];
        PCAP_SPI_ENABLE;        
        BSP_SPI_Transmit(cmd, 4);
        PCAP_SPI_DISABLE;
    }
}

/**@brief       读取PCap芯片状态
* @return       函数执行结果
* - PCap状态寄存器值
*/
uint32_t PCap_Res_Sta(void)
{
    uint8_t cmd[4];
    uint8_t receive[4];

    PCAP_SPI_ENABLE;
    cmd[0] = PCAP_READ_RESULT_OPT | RESULT_STATUS_ADDR;
    cmd[1] = 0;
    cmd[2] = 0;
    cmd[3] = 0;
    BSP_SPI_TransmitReceive(cmd, receive, 4);
    PCAP_SPI_DISABLE;
    return (receive[1] << 16) | (receive[2] << 8) | receive[3];
}

/**@brief       读取PCap读寄存器数据
* @param[in]    reg_addr : 读寄存器地址
* @return       函数执行结果
* - PCap读寄存器的数据
*/
uint32_t PCap_Res_Data(uint8_t reg_addr)
{
    uint8_t cmd[4];
    uint8_t receive[4];

    PCAP_SPI_ENABLE;
    cmd[0] = PCAP_READ_RESULT_OPT | reg_addr;
    cmd[1] = 0;
    cmd[2] = 0;
    cmd[3] = 0;
    BSP_SPI_TransmitReceive(cmd, receive, 4);
    PCAP_SPI_DISABLE;
    return (receive[1] << 16) | (receive[2] << 8) | receive[3];
}

